<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Liga de Baloncesto Persistente</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; }
textarea { width: 100%; height: 100px; margin-bottom: 10px; }
button { margin: 5px; padding: 10px; cursor: pointer; }
h2 { margin-top: 20px; }
ul { list-style: none; padding: 0; }
li { margin: 3px 0; }
.equipo { display: inline-block; width: 45%; vertical-align: top; }
#historial { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 10px; }
</style>
</head>
<body>

<h1>Liga de Baloncesto Autom√°tica üèÄ</h1>

<h2>Lista de jugadores (marca invitados con "(invitado)")</h2>
<textarea id="lista"></textarea><br>
<button onclick="cargarLista()">Cargar lista</button>
<button onclick="siguientePartido()">‚û°Ô∏è Siguiente Partido</button>
<button onclick="ganaA()">üèÜ Gana Equipo A</button>
<button onclick="ganaB()">üèÜ Gana Equipo B</button>
<button onclick="resetearLiga()">üîÑ Resetear Liga</button>

<h2>Partido #<span id="nPartido">0</span> (<span id="modo">normal</span>)</h2>

<div class="equipo">
  <h3>Equipo A</h3>
  <ul id="equipoA"></ul>
</div>

<div class="equipo">
  <h3>Equipo B</h3>
  <ul id="equipoB"></ul>
</div>

<div id="historial">
  <h3>üìã Historial de partidos</h3>
  <ul id="listaHistorial"></ul>
</div>

<script>
let colaLiga = [];
let colaInvitados = [];
let campeon = [];           // equipo que defiende el t√≠tulo
let A = [], B = [];
let modo = 'normal';        // 'normal', 'retador', 'campeonVsRetador'
let nPartido = 0;
let consecutivosA = 0;
let consecutivosB = 0;
let ultimoEnCancha = new Set();
let historial = [];

function guardarEstado() {
  localStorage.setItem('ligaData', JSON.stringify({
    colaLiga, colaInvitados, campeon, A, B,
    modo, nPartido, consecutivosA, consecutivosB,
    historial
  }));
}

function cargarEstado() {
  const data = JSON.parse(localStorage.getItem('ligaData') || '{}');
  if (data.colaLiga) {
    Object.assign(window, data);
    mostrarEquipos();
    mostrarHistorial();
  }
}

function cargarLista(){
  const lines = document.getElementById('lista').value.split('\n').map(l=>l.trim()).filter(l=>l);
  if (lines.length < 10) return alert("‚ö†Ô∏è Debes tener al menos 10 jugadores.");
  colaLiga = [];
  colaInvitados = [];
  lines.forEach(j=>{
    if(j.toLowerCase().includes('(invitado)')){
      colaInvitados.push(j);
    } else {
      colaLiga.push(j);
    }
  });
  nPartido = 0;
  modo='normal';
  consecutivosA=consecutivosB=0;
  campeon=[];
  historial=[];
  alert("‚úÖ Lista cargada con "+lines.length+" jugadores");
  guardarEstado();
}

function tomar(cola,n,ex=new Set()){
  const seleccion=[];
  let i=0;
  while(seleccion.length<n && cola.length>0){
    const jugador=cola.shift();
    if(!ex.has(jugador)){
      seleccion.push(jugador);
      ex.add(jugador);
    }
    cola.push(jugador);
    i++;
    if(i>cola.length*2) break;
  }
  return seleccion;
}

function retador(){
  let ex=new Set([...ultimoEnCancha, ...campeon]);
  const L = tomar(colaLiga,6,ex);
  const I = tomar(colaInvitados,4,ex);
  let equipo = [...L,...I];
  while(equipo.length<10){
    equipo.push(...tomar([...colaLiga,...colaInvitados],10-equipo.length,ex));
  }
  return equipo;
}

function generarEquipos(){
  if (colaLiga.length + colaInvitados.length < 10) {
    alert("‚ö†Ô∏è No hay suficientes jugadores para un nuevo partido.");
    return;
  }

  let ex = new Set([...ultimoEnCancha, ...campeon]);

  if (nPartido === 0) {
    const primeros = tomar(colaLiga,10,ex);
    A = primeros.slice(0,5);
    B = primeros.slice(5,10);
  } 
  else if (modo === 'normal') {
    const nuevos = retador();
    A = nuevos.slice(0,5);
    B = nuevos.slice(5,10);
  } 
  else if (modo === 'retador') {
    // partido entre 10 nuevos jugadores
    const nuevos = retador();
    A = nuevos.slice(0,5);
    B = nuevos.slice(5,10);
  } 
  else if (modo === 'campeonVsRetador') {
    // campe√≥n enfrenta al retador
    if (Math.random() < 0.5) {
      A = campeon;
      B = retadorActual;
    } else {
      A = retadorActual;
      B = campeon;
    }
  }

  ultimoEnCancha = new Set([...A, ...B]);
  mostrarEquipos();
  guardarEstado();
}

function mostrarEquipos(){
  document.getElementById('equipoA').innerHTML = A.map(j=>"<li>"+j+"</li>").join('');
  document.getElementById('equipoB').innerHTML = B.map(j=>"<li>"+j+"</li>").join('');
  document.getElementById('nPartido').textContent = nPartido;
  document.getElementById('modo').textContent = modo;
}

function siguientePartido(){
  nPartido++;
  generarEquipos();
}

function registrarResultado(ganador, perdedor){
  historial.push({ partido: nPartido, ganador, perdedor });
  mostrarHistorial();
}

function mostrarHistorial(){
  document.getElementById('listaHistorial').innerHTML =
    historial.map(h=>`<li>Partido #${h.partido}: üèÜ ${h.ganador.join(', ')} venci√≥ a ${h.perdedor.join(', ')}</li>`).join('');
}

let retadorActual = [];

function ganaA(){
  procesarGanador(A, B);
}

function ganaB(){
  procesarGanador(B, A);
}

function procesarGanador(ganador, perdedor){
  registrarResultado(ganador, perdedor);

  if (modo === 'normal') {
    // modo normal: si gana dos veces seguidas ‚Üí se convierte en campe√≥n
    if (ganador === A) consecutivosA++; else consecutivosA=0;
    if (ganador === B) consecutivosB++; else consecutivosB=0;

    if (consecutivosA >= 2 || consecutivosB >= 2) {
      campeon = ganador;
      modo = 'retador'; // entra modo retador (10 nuevos)
    }
  } 
  else if (modo === 'retador') {
    // el ganador de este partido se convierte en el retador del campe√≥n
    retadorActual = ganador;
    modo = 'campeonVsRetador';
  } 
  else if (modo === 'campeonVsRetador') {
    // campe√≥n vs retador: el que gana es el nuevo campe√≥n
    campeon = ganador;
    modo = 'retador'; // inmediatamente busca un nuevo retador
  }

  guardarEstado();
}

function resetearLiga(){
  if(confirm("¬øSeguro que quieres reiniciar la liga?")){
    localStorage.removeItem('ligaData');
    location.reload();
  }
}

cargarEstado();
</script>
</body>
</html>